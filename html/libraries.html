<html>
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script language="Javascript">
        function refreshLibraries() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/libraries');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = () => {
                const info = JSON.parse(xhr.responseText);
                const librariesNode = $('#libraries tbody');
                librariesNode.html("");

                Object.keys(info).forEach(libraryId => {
                    const library = info[libraryId];
                    const row = $("<tr class='libraryrow'><td class='libraryname' /><td class='libraryversions' /></tr>");
                    row.find('.libraryname').html(library.name);
                    Object.keys(library.versions).forEach(versionId => {
                        const version = library.versions[versionId];
                        const versionlink = $("<a class='libraryversion' />");
                        versionlink.data('libraryId', libraryId);
                        versionlink.data('versionId', versionId);
                        versionlink.data('version', version);
                        versionlink.attr('href', "javascript:;");
                        versionlink.html(version);
                        versionlink.click(toggleMatrix);

                        row.find('.libraryversions').append(versionlink);
                    });
                    librariesNode.append(row);

                    const matrixNode = $("<tr class='librarymatrixrow'><td colspan='2' class='librarymatrix' /></tr>");
                    matrixNode.attr("id", libraryId);
                    matrixNode.hide();
                    librariesNode.append(matrixNode);
                });
            };
            xhr.send();
        }

        function refreshMatrix(libraryId, libraryVersion, matrixNode) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/binaries/' + libraryId + '/' + libraryVersion);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = () => {
                const info = JSON.parse(xhr.responseText);
                matrixNode.find("td").html("");

                const matrixTable = $("<table><thead><tr class='binmatrixheader' /></thead><tbody /></table>");
                const header = matrixTable.find('.binmatrixheader');

                const tdCompiler = $("<td class='binmatrixheadercompiler'>Compiler</td>");
                header.append(tdCompiler);

                info.possibleCombinations.forEach(combination => {
                    const td = $("<td class='binmatrixheaderoption' />");
                    td.html(combination.arch + "<br />" + combination.build_type + "<br />" + combination.flagcollection);
                    header.append(td);
                });

                Object.keys(info.perCompiler).forEach(compilerId => {
                    const compiler = info.perCompiler[compilerId];
                    const row = $("<tr class='binmatrixrow'><td class='compilername' /></tr>");
                    row.find('.compilername').html(compiler.name);

                    for (let idxCombination = 0; idxCombination < info.possibleCombinations.length; idxCombination++) {
                        const tdCombinationYesNo = $("<td class='binmatrixheaderoptionyesno' />");
                        if (compiler.combinations.includes(idxCombination)) {
                            tdCombinationYesNo.addClass("yes");
                            tdCombinationYesNo.html("x");
                        }
                        row.append(tdCombinationYesNo);
                    }

                    matrixTable.find("tbody").append(row);
                });

                matrixNode.find("td").append(matrixTable);
            };
            xhr.send();
        }

        function toggleMatrix() {
            const link = $(this);
            const libraryId = link.data("libraryId");
            const versionId = link.data("versionId");
            const version = link.data("version");

            const matrixNode = $("#" + libraryId);
            refreshMatrix(libraryId, version, matrixNode);
            matrixNode.show();
        }

        $(document).ready(() => {
            refreshLibraries();
        });
    </script>
</head>
<body>
    <table id="libraries">
        <thead>
            <td width='200px'>Name</td><td>Versions</td>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>
</html>
